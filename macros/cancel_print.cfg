[gcode_macro CANCEL_PRINT]
# Macro to handle print cancellation tasks
rename_existing: BASE_CANCEL_PRINT
gcode:

    ; Check if the current Z position is less than 200mm
    {% if (printer.gcode_move.position.z) < 200 %}
        # Move the nozzle up to 200mm at a speed of 600mm/min
        G1 Z200 F600                                      
    {% endif %}

    ; Check if the current Y position is greater than 300mm
    {% if (printer.gcode_move.position.y) > 300 %}
        # Move the nozzle to Y=250mm at a speed of 6000mm/min
        G1 Y250 F6000
    {% endif %}

    ; Move the nozzle to the purge bucket location (X=93, Y=324) at a speed of 7800mm/min
    G1 X93 Y324 F7800

    ; Reset the idle timeout to its original value from the configuration file
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}

    ; Clear any active pause state
    CLEAR_PAUSE

    ; Turn off all fans (main, secondary, and tertiary)
    M106 P2 S0
    M106 P0 S0
    M106 P3 S0

    ; Turn off the extruder heater
    M104 S0

    ; Turn off the bed heater
    M140 S0

    ; Turn off any additional heaters (if applicable)
    M141 S0

    ; Reset the speed factors for extrusion and movement to 100%
    M220 S100
    M221 S100

    ; Disable the X stepper motor
    SET_STEPPER_ENABLE STEPPER=stepper_x enable=0

    ; Disable the Y stepper motor
    SET_STEPPER_ENABLE STEPPER=stepper_y enable=0

    ; Enable the Z stepper motors to ensure they remain active (if needed)
    SET_STEPPER_ENABLE STEPPER=stepper_z enable=1
    SET_STEPPER_ENABLE STEPPER=stepper_z1 enable=1

    ; Disable the extruder stepper motor
    SET_STEPPER_ENABLE STEPPER=extruder enable=0

    ; Disable all sensors to prevent false triggers
    DISABLE_ALL_SENSORS

    ; Clear any stored bed mesh data
    BED_MESH_CLEAR

    ; Perform a Z probe to ensure the nozzle is at a known position
    G31

    ; Disable all motors to save power and prevent overheating
    M84

    ; Reset the SD card file state
    SDCARD_RESET_FILE

    ; Call the original CANCEL_PRINT macro (BASE_CANCEL_PRINT)
    BASE_CANCEL_PRINT

    ; Clear the last file information from memory
    CLEAR_LAST_FILE